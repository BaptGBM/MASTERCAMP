<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EcoTrash - Visualisation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-gray-900 text-white py-4 shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-green-400">EcoTrash</h1>
      <nav>
        <ul class="flex gap-6 text-sm">
            <li><a href="{{ url_for('index') }}" class="hover:underline">Accueil</a></li>
            <a href="{{ url_for('dashboard') }}" class="hover:underline">Dashboard</a>
            <li><a href="{{ url_for('config') }}" class="hover:underline">Configuration</a></li>
            <li><a href="{{ url_for('visualisation') }}" class="hover:underline">Visualisation</a></li>
            <li><a href="{{ url_for('map_view') }}" class="hover:underline">Carte</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- TITRE -->
  <section class="text-center py-16 bg-gradient-to-r from-blue-500 to-purple-500 text-white">
    <h2 class="text-4xl font-bold mb-2">üìä Visualisation des Donn√©es</h2>
    <p class="text-lg">R√©partition des annotations entre poubelles pleines et vides</p>
  </section>

  <!-- CONTENU -->
  <main class="flex-grow container mx-auto px-6 py-12">
    <!-- Grille de graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      
      <!-- ü•ß R√©partition Pleine / Vide -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-semibold text-center text-gray-700 mb-6">üìä R√©partition Pleine / Vide</h3>
        <canvas id="pieChart" class="mb-4"></canvas>
        <div class="text-sm text-center text-gray-600">
          <p><strong>Total analys√©es :</strong> {{ pleines + vides }}</p>
          <p><strong>Pleines :</strong> {{ pleines }} | <strong>Vides :</strong> {{ vides }}</p>
        </div>
      </div>

      <!-- üìä Score moyen IA par annotation -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-semibold text-center text-gray-700 mb-6">üéØ Score Moyen IA</h3>
        <canvas id="barAvgScore" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">Pr√©cision de l'IA par type d'annotation</p>
      </div>

      <!-- üìà √âvolution temporelle -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-semibold text-center text-gray-700 mb-6">üìà √âvolution des Uploads</h3>
        <canvas id="uploadChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">Nombre d'images upload√©es par jour</p>
      </div>

      <!-- üìâ Distribution des scores -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-semibold text-center text-gray-700 mb-6">üìâ Distribution des Scores IA</h3>
        <canvas id="scoreChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">R√©partition des scores de confiance</p>
      </div>

    </div>

    <!-- Graphiques avanc√©s -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8 mb-8">
      
      <!-- üîç Analyse des caract√©ristiques -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">üîç Analyse Technique</h3>
        <canvas id="featuresChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">Contraste, saturation et pixels sombres</p>
      </div>

      <!-- üíæ Distribution des tailles -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">üíæ Tailles de Fichiers</h3>
        <canvas id="sizeChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">R√©partition par gamme de taille</p>
      </div>

      <!-- üé® Analyse des couleurs -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">üé® Profil Couleur</h3>
        <canvas id="colorChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">Couleurs moyennes RGB par annotation</p>
      </div>

    </div>

    <!-- Graphiques temporels avanc√©s -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- üìÖ Tendances mensuelles -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">üìÖ Tendances Mensuelles</h3>
        <canvas id="monthlyChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">√âvolution des annotations par mois</p>
      </div>

      <!-- üìê R√©solutions populaires -->
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-center text-gray-700 mb-6">üìê R√©solutions Populaires</h3>
        <canvas id="resolutionChart" class="mb-4"></canvas>
        <p class="text-xs text-center text-gray-500">Top 10 des r√©solutions d'images</p>
      </div>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gray-900 text-gray-300 py-6 text-center">
    <p>&copy; 2025 EcoTrash. Tous droits r√©serv√©s.</p>
  </footer>

  <!-- SCRIPTS -->
  <script>
    const pleines = {{ pleines }};
    const vides = {{ vides }};

    const data = {
      labels: ['Pleine', 'Vide'],
      datasets: [{
        label: 'R√©partition des annotations',
        data: [pleines, vides],
        backgroundColor: ['#EF4444', '#10B981'],
        hoverOffset: 8,
      }]
    };

    const config = {
      type: 'doughnut',
      data: data,
      options: {
        plugins: {
          legend: {
            position: 'bottom'
          },
          datalabels: {
            color: '#fff',
            font: {
              weight: 'bold',
              size: 16
            },
            formatter: (value, ctx) => {
              let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              let percent = (value / total * 100).toFixed(1) + '%';
              return percent;
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    };

    new Chart(document.getElementById('pieChart'), config);
  </script>

  <script>
  fetch("/api/scores")
    .then(res => res.json())
    .then(scores => {
      new Chart(document.getElementById('scoreChart'), {
        type: 'bar',
        data: {
          labels: scores.map((_, i) => `#${i + 1}`),
          datasets: [{
            label: "Score IA (%)",
            data: scores.map(s => s * 100),
            backgroundColor: "#6366f1"
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    });
  </script>

  <script>
  fetch("/api/uploads_by_date")
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);
      new Chart(document.getElementById("uploadChart"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Uploads par jour",
            data: values,
            fill: false,
            borderColor: "#10b981"
          }]
        }
      });
    });
  </script>

  <script>
  fetch("/api/score_par_annotation")
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById("barAvgScore"), {
        type: "bar",
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: "Score moyen IA (%)",
            data: Object.values(data),
            backgroundColor: ["#f87171", "#34d399"]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    });
  </script>

  <!-- üîç Analyse des caract√©ristiques techniques -->
  <script>
  fetch("/api/features_analysis")
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById("featuresChart"), {
        type: "radar",
        data: {
          labels: ["Contraste", "Saturation", "Pixels Sombres (%)"],
          datasets: [
            {
              label: "Pleines",
              data: [data.contrast.Pleine, data.saturation.Pleine, data.dark_pixels.Pleine],
              backgroundColor: "rgba(239, 68, 68, 0.2)",
              borderColor: "#ef4444",
              borderWidth: 2
            },
            {
              label: "Vides",
              data: [data.contrast.Vide, data.saturation.Vide, data.dark_pixels.Vide],
              backgroundColor: "rgba(16, 185, 129, 0.2)",
              borderColor: "#10b981",
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            r: {
              beginAtZero: true
            }
          }
        }
      });
    });
  </script>

  <!-- üíæ Distribution des tailles de fichiers -->
  <script>
  fetch("/api/size_distribution")
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById("sizeChart"), {
        type: "doughnut",
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: [
              "#3b82f6", "#8b5cf6", "#f59e0b", 
              "#ef4444", "#10b981"
            ],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  size: 10
                }
              }
            }
          }
        }
      });
    });
  </script>

  <!-- üé® Analyse des couleurs RGB -->
  <script>
  fetch("/api/color_analysis")
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById("colorChart"), {
        type: "bar",
        data: {
          labels: ["Rouge", "Vert", "Bleu"],
          datasets: [
            {
              label: "Pleines",
              data: [data.pleine.r, data.pleine.g, data.pleine.b],
              backgroundColor: ["#fca5a5", "#86efac", "#93c5fd"]
            },
            {
              label: "Vides",
              data: [data.vide.r, data.vide.g, data.vide.b],
              backgroundColor: ["#ef4444", "#10b981", "#3b82f6"]
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 255
            }
          }
        }
      });
    });
  </script>

  <!-- üìÖ Tendances mensuelles -->
  <script>
  fetch("/api/monthly_trends")
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById("monthlyChart"), {
        type: "line",
        data: {
          labels: data.labels,
          datasets: [
            {
              label: "Total",
              data: data.total,
              borderColor: "#6366f1",
              backgroundColor: "rgba(99, 102, 241, 0.1)",
              fill: true
            },
            {
              label: "Pleines",
              data: data.pleines,
              borderColor: "#ef4444",
              backgroundColor: "rgba(239, 68, 68, 0.1)"
            },
            {
              label: "Vides",
              data: data.vides,
              borderColor: "#10b981",
              backgroundColor: "rgba(16, 185, 129, 0.1)"
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    });
  </script>

  <!-- üìê R√©solutions populaires -->
  <script>
  fetch("/api/resolution_stats")
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);
      
      new Chart(document.getElementById("resolutionChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Nombre d'images",
            data: values,
            backgroundColor: "#8b5cf6",
            borderColor: "#7c3aed",
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    });
  </script>

</body>
</html>
